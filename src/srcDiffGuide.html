<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xi="http://www.w3.org/2001/XInclude" xml:lang="en" lang="en">
  <head>

    <title>srcDiff Guide</title>

  </head>
  <body>

    <h1>srcDiff Guide</h1>

    <p>This is a general guide to the srcDiff format, both in generation
      and querying.</p>

    <p>The srcDiff format is an extension to srcML.  The namespace is:
</p>
<pre>
http://www.sdml.info/srcDiff
</pre>

    <p>with a default prefix is <code>diff</code>.  The namespace
    primarily consists of the elements:
</p>

    <ul>
      <li><code>&lt;diff:insert</code>&gt;</li>
      <li><code>&lt;diff:delete</code>&gt;</li>
    </ul>

    <p>
      These elements are used to wrap the srcML elements and
      source-code text that is part of a difference.  Code that is not
      contained in these elements is common to both versions.  Due to
      well-formedness requirements of XML, another
      element <code>&lt;diff:common</code>&gt; may be nested
      in <code>&lt;diff:insert</code>&gt;
      or <code>&lt;diff:delete</code>&gt;.
    </p>

    <p>
      The format contains both versions of the document.  Both
      versions contain all content that is in common, i.e., not
      contained in a srcDiff element, or is directly in
      a <code>&lt;diff:common&gt;</code> element.  The first version
      additionally includes the contents of
      the <code>&lt;diff:delete&gt;</code> element.  The second
      version additionally includes the contents of
      the <code>&lt;diff:insert&gt;</code> elements.
    </p>

    <p>
      Since content that is not inside a srcDiff element is in common,
      a document with no changes will contain no srcDiff elements but
      only have the namespace for srcDiff declared.
    </p>

    <p>
      srcDiff elements can include an attribute for special cases:
    </p>

    <ul>
      <li><code>type="whitespace"</code> Deleted or inserted content of
      the srcDiff element is
      whitespace only (space, tab, newline).</li>
      <li><code>type="change"</code> The <code>&lt;diff:insert&gt;</code>
      or <code>&lt;diff:delete&gt;</code> is part of a matched set of
      inserts and deletes.</li>
    </ul>

<h3>Generating srcDiff</h3>

<p>The srcDiff format is generated by the <code>srcdiff</code> tool.
  For example, to convert two versions of the same file to the srcdiff
  format:
</p>

<pre>
srcdiff.exe v1\main.cpp v2\main.cpp -o main.cpp.xml
</pre>

<p>Note that the srcdiff tool internally takes care of the conversion
  to srcML.
</p>

<p>
In addition to conversion of two versions of the same file, the
srcdiff tool can also generate a srcDiff archive similar to a srcML
archive.  This can be done by providing pairs of multiple files as
arguments, or by creating a file list.  The file list is in the
following form:
</p>

<pre>
v1\main.cpp|v2\main.cpp
v1\f.hpp|v2\f.hpp
v1\f.cpp|v2\f.cpp
</pre>

<p>
Each pair of files is listed on a single line.  The two filenames are
separated by a vertical bar '|'.  The filename attribute of the srcML
element <code>&lt;unit&gt;</code> also contains both filenames
separated in the same manner.
</p>

<p>
The code for the input options to srcdiff are taken from the code in
src2srcml, and we expect to eventually be able to handle all the input variations
of src2srcml in the srcdiff tool, e.g., input from tar archives.  This
would allow someone to specify two tar files consisting of two
different releases of a project.
</p>

<h3>srcDiff Queries</h3>

<p>
The srcDiff elements form an axis through the document.  These can be
combined with the srcML elements in a query.  Here are a number of
typical situations:
</p>

<p>
To find if a particular part of the code is deleted, we look at the
srcDiff element that it is directly contained in, since the srcDiff
elements may be nested.  For example, to find all deleted functions
the query would be:
</p>

<pre>
//src:function[ancestor::diff:*[1][self::diff:delete]]
</pre>

<p>
The first part of the predicate <code>ancestor::diff:*[1]</code> finds
the first containing srcDiff element in the reverse direction.  This
resulting element is checked to see that it is a delete.  While the
predicate may be verbose, it is actually computed quite efficiently
since the XPath evaluator must keep track of any open elements.
Finding inserted srcML can be done in a similar fashion by checking
for a <code>self::diff:delete</code>.
</p>

<p>
To find if a particular part of the code contains deleted or inserted
content, we look at the srcDiff elements that it contains.  For
example, to find all functions that contain deleted content the query
would be:
</p>

<pre>
//src:function[descendant::diff:delete]
</pre>

<p>
The predicate <code>descendant::diff:delete</code> finds
the first containing srcDiff element in the reverse direction.  This
resulting element is checked to see that it is a delete.  While the
predicate may be verbose, it is actually computed quite efficiently
since the XPath evaluator must keep track of any open elements.
Finding inserted srcML can be done in a similar fashion by checking
for a <code>self::diff:delete</code>.
</p>

  </body>
</html>
