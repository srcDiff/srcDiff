<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xi="http://www.w3.org/2001/XInclude" xml:lang="en" lang="en">
  <head>

    <title>srcDiff Guide</title>

  </head>
  <body>

    <h2>General Guide to srcDiff</h2>

    <p>The srcDiff format is an extension of srcML with the namespace
      <code>http://www.sdml.info/srcDiff</code> and the default prefix is <code>diff</code>.  The namespace
      primarily consists of the elements:
    </p>

    <ul>
      <li><code>&lt;diff:insert</code>&gt;</li>
      <li><code>&lt;diff:delete</code>&gt;</li>
    </ul>

    <p>
      These elements are used to wrap the srcML elements and
      source-code text that is part of a difference.  Code that is not
      contained in these elements is common to both versions.  Due to
      well-formedness requirements of XML, another
      element <code>&lt;diff:common</code>&gt; may be nested
      in <code>&lt;diff:insert</code>&gt;
      or <code>&lt;diff:delete</code>&gt;.
    </p>

    <p>
      The format contains both versions of the document.  Both
      versions contain all content that is in common, i.e., not
      contained in a srcDiff element, or is directly in
      a <code>&lt;diff:common&gt;</code> element.  The first version
      also includes the contents of
      the <code>&lt;diff:delete&gt;</code> element, and the second
      version also includes the contents of
      the <code>&lt;diff:insert&gt;</code> elements.
    </p>

    <p>
      Since content that is not inside a srcDiff element is in common,
      a document with no changes will contain no srcDiff elements but
      only have the namespace for srcDiff declared.
    </p>

    <p>
      The srcDiff element uses the attribute <cite>type</cite> for special cases:
    </p>

    <ul>
      <li><code>type="whitespace"</code> Deleted or inserted content of
        the this change
        whitespace only (space, tab, newline).</li>
      <li><code>type="change"</code> The <code>&lt;diff:insert&gt;</code>
        or <code>&lt;diff:delete&gt;</code> is part of a matched set of
        inserts and deletes.</li>
    </ul>

    <h3>Generating srcDiff</h3>

    <p>
      The srcDiff format is produced by a primarily syntax
      differencing approach with careful attention paid to whitespace
      and other formatting.  The differences are computed down to the
      individual, low-level syntax, e.g., identifier, operator.
    </p>

    <p>The srcDiff format is generated by the <code>srcdiff</code> tool.
      For example, to convert two versions of the same file to the srcDiff
      format:
    </p>

    <pre style="text-align : center">
      srcdiff.exe v1\main.cpp v2\main.cpp -o main.cpp.xml
    </pre>

    <p>Note that the <code>srcdiff</code> tool internally takes care of the conversion
      to srcML.
    </p>

    <p>
      In addition to conversion of two versions of the same file, the
      <code>srcdiff</code>. tool can also generate a srcDiff archive similar to a srcML
      archive.  This can be done by providing pairs of multiple files as
      arguments, or by creating a file list.  The file list is in the
      following form:
    </p>

    <pre style="text-align : left">
      v1\main.cpp|v2\main.cpp
      v1\f.hpp|v2\f.hpp
      v1\f.cpp|v2\f.cpp
    </pre>

    <p>
      Each pair of files is listed on a single line.  The two filenames are
      separated by a vertical bar '|'.  The filename attribute of the srcML
      element <code>&lt;unit&gt;</code> also contains both filenames
      separated in the same manner.  To build a srcDiff archive from the
      given file list the command is:
    </p>

    <pre style="text-align : center">
      srcdiff.exe --files-from list.txt -o project.xml
    </pre>

    <p>
      Conversion to the srcDiff format is quite fast.  It takes no
      more then 3 times the speed of converting a single input file to
      srcML.  Note that each part of the pair of input files has to be
      converted (internally) to srcML.
    </p>

    <p>
      Once in the srcDiff format, <code>srcml2src</code> can also be
      used to work with srcDiff files.  Many of the options can be applied
      to a particular version of the code using the new
      option <code>--revision</code> which allows the selection of the first or
      second version of the document.  To extract the first version of the
      code the command is:
    </p>

    <pre style="text-align : center">
      srcml2src.exe --revision 1 main.cpp.xml
    </pre>

    <p>
      This selection of the particular version in the srcDiff file for
      processing can be applied to almost all other options in <code>srcml2src</code>.
      For example, to extract all the code in the files from the first
      version to the current directory, the command is:
    </p>

    <pre style="text-align : center">
      srcml2src.exe --revision 1 --to-dir=. project.xml
    </pre>

    <h3>Querying srcDiff</h3>

    <p>
      The srcDiff elements form a difference axis through the document,
      which can be combined with the srcML elements in a query.  To find if
      a particular part of the code is deleted, we look at the srcDiff
      element that it is directly contained in, since the srcDiff elements
      may be nested.  For example, to find all deleted functions the query
      would be:
    </p>

    <pre style="text-align : center">
      //src:function[ancestor::diff:*[1][self::diff:delete]]
    </pre>

    <p>
      The first part of the predicate <code>ancestor::diff:*[1]</code> finds
      the first containing srcDiff element in the reverse direction.  This
      resulting element is checked to see that it is a delete.  While the
      predicate may be verbose, it is actually computed quite efficiently
      since the XPath evaluator must keep track of any open elements.
      Finding inserted srcML can be done in a similar fashion by checking
      for a <code>self::diff:insert</code>.
    </p>

    <p>
      To find if a particular part of the code contains deleted or inserted
      content, we look at the srcDiff elements that it contains.  For
      example, to find all functions that contain deleted content the query
      would be:
    </p>

    <pre style="text-align : center">
      //src:function[descendant::diff:delete]
    </pre>

    <p>
      The predicate <code>descendant::diff:delete</code> finds
      any delete that is inside the function.  In this case
      the predicate is much less verbose, but requires traversing the entire
      tree inside the src:function.
      Finding contained srcML can be done in a similar fashion with the predicate
      <code>descendant::diff:insert</code>.
    </p>

    <p>
      In order to make queries involving srcDiff more convenient and easier
      to use, a set of XPath extensions function has been created to
      hide much of these complexities.  These extension functions are directly
      available for use as in XPath queries and XSLT programs in the srcML
      tool <code>srcml2src</code>.  The definitions for them are included so
      they can also be used in other XPath tools.  The functions are
      used as predicates to filter the srcML content.
    </p>

    <table align="center">
      <tr>
        <th>Function</th><th>Description</th>
      </tr>

      <tr>
        <td style="vertical-align : top"><code>diff:deleted()</code></td><td>srcML was deleted<br/>
          Equivalency:  <code>ancestor::diff:*[1][self::diff:delete]</code></td>
      </tr>

      <tr>
        <td style="vertical-align : top"><code>diff:inserted()</code></td><td>srcML was inserted<br/>
          Equivalency:  <code>ancestor::diff:*[1][self::diff:insert]</code></td>
      </tr>

      <tr>
        <td style="vertical-align :
                   top"><code>diff:difference()</code></td><td>srcML was inserted or deleted<br/>
          Equivalency: <code>ancestor::diff:*[1][self::diff:insert or self::diff:delete]</code>
        </td>
      </tr>

      <tr>
        <td style="vertical-align : top"><code>diff:common()</code></td><td>srcML was common to
          both versions<br/>
          Equivalency: <code>not(ancestor::diff:*[1][self::diff:insert or self::diff:delete])</code>
        </td>
      </tr>

      <!--
          <tr>
            <td style="vertical-align :
                       top"><code>diff:changed()</code></td><td>srcML contains
              content that was deleted and directly replaced by inserted source<br/>
              Equivalency: <code>descendant::diff:*[@type='changed'][1]</code>
            </td>
          </tr>
          -->
      <tr>
        <td> <br/></td>
        <td> </td>
      </tr>

      <tr>
        <td style="vertical-align :
                   top"><code>diff:hasdelete()</code></td><td>srcML contains
          content that was deleted<br/>
          Equivalency:  <code>descendant::diff:delete[1]</code></td>
      </tr>

      <tr>
        <td style="vertical-align :
                   top"><code>diff:hasinsert()</code></td><td>srcML
          contains content that was inserted<br/>
          Equivalency:  <code>descendant::diff:insert[1]</code></td>
      </tr>

      <tr>
        <td style="vertical-align :
                   top"><code>diff:hasdifference()</code></td><td>srcML contains
          content that was deleted or inserted<br/>
          Equivalency: <code>descendant::diff:*[self::diff:insert or self::diff:delete]</code>
        </td>
      </tr>

      <!--
          <tr>
            <td style="vertical-align :
                       top"><code>diff:hascommon()</code></td><td>srcML contains
              content that are common to both versions (assumes surrounding context is common)<br/>
              Equivalency: <code>self::*[not(descendant::diff:*) or descendant::diff:common]</code>
            </td>
          </tr>
          -->

      <!--
          <tr>
            <td style="vertical-align :
                       top"><code>diff:haschange()</code></td><td>srcML contains
              content that was deleted and directly replaced by inserted source<br/>
              Equivalency: <code>descendant::diff:*[@type='changed'][1]</code>
            </td>
          </tr>
          -->

    </table>

    <p>
      We will now show some examples of how srcDiff can be queried using the
      extension functions, or the equivalent direct XPath.
    </p>

    <table align="center">
      <tr>
        <th>Query</th>
        <th>Description</th>
      </tr>

      <tr>
        <td>Deleted functions:</td>
        <td>
          <pre>
            //src:function[diff:deleted()]
          </pre>
        </td>
      </tr>

      <tr>
        <td>Inserted functions:</td>
        <td>
          <pre>
            //src:function[diff:inserted()]
          </pre>
        </td>
      </tr>

      <tr>
        <td>Common functions (in both versions):</td>
        <td>
          <pre>
            //src:function[diff:common()]
          </pre>
        </td>
      </tr>

      <tr>
        <td>Inserted or deleted functions:</td>
        <td>
          <pre>
            //src:function[diff:difference()]
          </pre>
        </td>
      </tr>

      <!--
          <tr>
            <td>Functions which were part of a insert or delete:</td>
            <td>
              <pre>
                //src:function[diff:changed()]
              </pre>
            </td>
          </tr>
          -->

      <tr>
        <td>Function which contains a delete:</td>
        <td>
          <pre>
            //src:function[diff:hasdelete()]
          </pre>
        </td>
      </tr>

      <tr>
        <td>Function which contains an insert:</td>
        <td>
          <pre>
            //src:function[diff:hasinsert()]
          </pre>
        </td>
      </tr>

      <!--
          <tr>
            <td>Function which has content in common (assumes deleted and inserted functions are filtered out):</td>
            <td>
              <pre>
                //src:function[diff:hascommon()]
              </pre>
            </td>
          </tr>
          -->

      <tr>
        <td>Function contains inserts or deletes:</td>
        <td>
          <pre>
            //src:function[diff:hasdifference()]
          </pre>
        </td>
      </tr>

    </table>

    <p>
      More extension functions will be created as needed.
    </p>

    <p>
      The results of these queries can be further refined to give the
      desired data.  For example, to find all conditions in deleted functions:
    </p>

    <pre style="text-align : center">
      //src:function[diff:deleted()]//src:condition
    </pre>

    <p>
      When querying srcDiff it is important to remember that unless
      specified, the result will include all elements, regardless if they
      were inserted, deleted, or unchanged.  The following will find if all
      inserted conditions inside of a function that is in common (i.e., the
      function was not inserted or deleted):
    </p>

    <pre style="text-align : center">
      //src:function[diff:common()]//src:condition[diff:deleted()]
    </pre>

    <p>
      More examples can be found in the following table:
    </p>

    <table align="center">
      <tr>
        <th>Query</th>
        <th>Description</th>
      </tr>

      <tr>
        <td>Parameters deleted from function definitions:</td>
        <td>
          <pre>
            //src:function[diff:common()]//src:param[diff:deleted()]
          </pre>
        </td>
      </tr>

      <tr>
        <td>Parameters inserted to function definitions:</td>
        <td>
          <pre>
            //src:function[diff:common()]//src:param[diff:inserted()]
          </pre>
        </td>
      </tr>

      <tr>
        <td>Parameters which exist in both versions, but contain a change:</td>
        <td>
          <pre>
            //src:function[diff:common()]//src:param[diff:hasdifference()]
          </pre>
        </td>
      </tr>

      <tr>
        <td>Parameters whose name was changed:</td>
        <td>
          <pre>
            //src:function[diff:common()]//src:param[diff:common]/src:name[diff:hasdifference()]
          </pre>
        </td>
      </tr>

      <tr>
        <td>Parameters whose type was changed:</td>
        <td>
          <pre>
            //src:function[diff:common()]//src:param[diff:common]/src:type[diff:hasdifference()]
          </pre>
        </td>
      </tr>

    </table>

    <h2>srcDiff Difference Marking</h2>

    <p>
      The addition of syntactic structure in differencing allows for more
      then one way to mark the same set of differences.  In order to allow
      for choices, <code>srcdiff</code> has the option <cite>--method</cite>
      that changes how differences are collected and grouped.  The two
      current methods are:
    </p>

    <p>
      <strong><code>raw</code></strong> marks each individual change down to
      the name level.  For example, if only the change was inside of a
      declaration where <code>int n = a + b;</code> became <code>int m = c
        + d;</code>, then this would be marked as 3 individual changes:
      <code>'a'->'b'</code>, <code>'c'->'d'</code>, and <code>'b'->'d'</code>.
    </p>

    <p>
      <strong><code>collect</code></strong> reduces the granularity of expression and declaration statements.
      For example, if only the change was inside of a
      declaration where <code>int n = a + b;</code> became <code>int m = c
        + d;</code>, then this would be marked as one large change, <code>'int n =
      a + b;'->'int m = c + d;'</code>.  Note that single changes would still be
      individually marked, e.g., <code>'a + b'->'c + d'</code>.
    </p>

    <p>
      The <code>collect</code> method is the default.  To use
      the <code>raw</code> method the command is:
    </p>

    <pre style="text-align : center">
      srcdiff.exe --method=raw v1\main.cpp v2\main.cpp
    </pre>

    <p>
      We believe this category may grow in the future.
    </p>

    <h3>Limitations</h3>

    <p>
      The current implementation has some limitations:
    </p>

    <ul>
      <li>
        The code for the input options to <code>srcdiff</code> is taken from the code in
        <code>src2srcml</code>, and we expect to eventually be able to handle all the input variations
        of <code>src2srcml</code> in the <code>srcdiff</code> tool, e.g., input from tar archives.  This
        would allow someone to specify two tar files consisting of two
        different releases of a project.  We also expect to be adding
        additional options, such as input direct from srcML (instead
        of internal translation).
      </li>

      <li>Most of the testing has been on C code.  We have not found
        any surprises with C++/Java, but are still testing.</li>

      <li>
        The differencing algorithm produces non-optimal results with
        certain sequences of statements with small changes that are
        inserted/deleted.  This is currently being improved.  In
        addition, we are currently paying close attention to when
        deletes/inserts occur in common structures, such as nested ifs
        and switch statements.
      </li>
    </ul>

    <pre>







    </pre>

  </body>
</html>
